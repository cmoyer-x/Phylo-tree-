#!/usr/bin/env bash

###############################################################################
# Bacterial Genomics Analysis Pipeline
#
# Core genome alignment → recombination detection → masked phylogeny
#
# Workflow:
#   Parsnp → harvesttools → Gubbins → mask recombination → IQ-TREE
#
# Author: Casey Moyer
###############################################################################

set -euo pipefail

###############################################################################
# Usage
###############################################################################

usage() {
    cat <<EOF

Bacterial Genomics Pipeline

Required arguments:
  -r  Reference genome FASTA
  -i  Directory containing strain FASTA files
  -o  Output directory

Optional arguments:
  -t  Threads for alignment/recombination (default: 8)
  -q  Threads for IQ-TREE (default: 4)
  -e  Conda environment name (optional)
  -h  Show this help message

Example:
  ./bacterial_pipeline.sh \\
      -r reference.fasta \\
      -i assemblies/ \\
      -o results/ \\
      -t 16 \\
      -q 8

EOF
    exit 1
}

###############################################################################
# Defaults
###############################################################################

THREADS=8
IQTREE_THREADS=4
CONDA_ENV=""

###############################################################################
# Parse arguments
###############################################################################

while getopts "r:i:o:t:q:e:h" opt; do
    case $opt in
        r) REFERENCE="$OPTARG" ;;
        i) STRAINS_DIR="$OPTARG" ;;
        o) OUTDIR="$OPTARG" ;;
        t) THREADS="$OPTARG" ;;
        q) IQTREE_THREADS="$OPTARG" ;;
        e) CONDA_ENV="$OPTARG" ;;
        h) usage ;;
        *) usage ;;
    esac
done

if [[ -z "${REFERENCE:-}" || -z "${STRAINS_DIR:-}" || -z "${OUTDIR:-}" ]]; then
    usage
fi

###############################################################################
# Logging
###############################################################################

log()  { echo "[INFO]  $(date '+%F %T') - $1"; }
warn() { echo "[WARN]  $(date '+%F %T') - $1"; }
err()  { echo "[ERROR] $(date '+%F %T') - $1" >&2; }

###############################################################################
# Pre-flight checks
###############################################################################

log "Starting pipeline"

[[ -f "$REFERENCE" ]] || { err "Reference not found: $REFERENCE"; exit 1; }
[[ -d "$STRAINS_DIR" ]] || { err "Strain directory not found: $STRAINS_DIR"; exit 1; }

FASTA_FILES=("$STRAINS_DIR"/*.fasta "$STRAINS_DIR"/*.fa)
if [ ${#FASTA_FILES[@]} -eq 0 ]; then
    err "No FASTA files found in $STRAINS_DIR"
    exit 1
fi

mkdir -p "$OUTDIR"
cd "$OUTDIR"

###############################################################################
# Optional Conda activation
###############################################################################

if [[ -n "$CONDA_ENV" ]]; then
    if command -v conda &> /dev/null; then
        log "Activating Conda environment: $CONDA_ENV"
        source "$(conda info --base)/etc/profile.d/conda.sh"
        conda activate "$CONDA_ENV"
    else
        warn "Conda not found. Skipping environment activation."
    fi
fi

###############################################################################
# Tool checks
###############################################################################

for tool in parsnp harvesttools run_gubbins.py iqtree python3; do
    command -v "$tool" &> /dev/null || {
        err "Required tool not found: $tool"
        exit 1
    }
done

###############################################################################
# Step 1: Parsnp
###############################################################################

log "Running Parsnp"

parsnp \
    -r "$REFERENCE" \
    -d "$STRAINS_DIR" \
    -p "$THREADS" \
    --skip-phylogeny \
    -o parsnp_output

[[ -f parsnp_output/parsnp.xmfa ]] || {
    err "Parsnp failed: XMFA not produced"
    exit 1
}

###############################################################################
# Step 2: Convert XMFA
###############################################################################

log "Converting XMFA → FASTA"

mkdir -p harvesttools

harvesttools \
    -x parsnp_output/parsnp.xmfa \
    -M harvesttools/gubbins_input.fasta

###############################################################################
# Step 3: Gubbins
###############################################################################

log "Running Gubbins"

mkdir -p gubbins
cp harvesttools/gubbins_input.fasta gubbins/
cd gubbins

run_gubbins.py \
    gubbins_input.fasta \
    --threads "$THREADS"

cd ..

###############################################################################
# Step 4: Mask recombination
###############################################################################

log "Masking recombinant regions"

[[ -f mask_gubbins_aln.py ]] || {
    err "mask_gubbins_aln.py not found in output directory"
    exit 1
}

python3 mask_gubbins_aln.py \
    --aln gubbins/gubbins_input.fasta \
    --gff gubbins/gubbins_input.recombination_predictions.gff \
    --out gubbins/masked_alignment.fasta

###############################################################################
# Step 5: IQ-TREE
###############################################################################

log "Running IQ-TREE"

mkdir -p iqtree
cp gubbins/masked_alignment.fasta iqtree/
cd iqtree

iqtree \
    -s masked_alignment.fasta \
    -nt "$IQTREE_THREADS" \
    -m GTR+G

cd ..

###############################################################################
# Completion
###############################################################################

log "Pipeline completed successfully"

log "Key outputs:"
log "  Core alignment:     parsnp_output/parsnp.xmfa"
log "  Masked alignment:   gubbins/masked_alignment.fasta"
log "  Final tree:         iqtree/masked_alignment.fasta.treefile"

exit 0
